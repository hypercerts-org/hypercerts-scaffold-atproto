{"id":"hypercerts-0yp","title":"Epic: PDS Deployment \u0026 End-to-End Integration","description":"## Goal\nDeploy the PDS sidecar auth service alongside the Certified PDS at `pds-eu-west4.test.certified.app`, configure the PDS to work with the sidecar, and verify the complete email-first passwordless login flow end-to-end from the scaffold app through the sidecar to the PDS and back.\n\n## Context\nWe are the Certified team and control the PDS deployment. The PDS currently runs stock `@atproto/pds` in standalone mode (it is its own authorization server). We need to:\n1. Co-deploy the sidecar auth service with the PDS\n2. Configure the PDS so the sidecar can override its OAuth authorization server metadata\n3. Set up Docker Compose with Caddy for TLS (sidecar on auth subdomain, PDS on main domain)\n4. Configure SMTP for OTP email delivery\n5. Test the complete flow: scaffold → PDS (PAR) → sidecar (email + OTP) → PDS (auth code) → scaffold (callback)\n6. Handle existing users who have password-based accounts\n\n## Architecture\n```\nInternet\n  │\n  ▼\nCaddy (TLS termination, routing)\n  ├── pds.certs.network      → PDS Core (port 3000)\n  ├── auth.pds.certs.network → Sidecar Auth Service (port 3001)\n  └── *.pds.certs.network    → PDS Core (handle resolution)\n```\n\nBoth PDS and sidecar run in the same Docker Compose stack, sharing:\n- A Docker network (sidecar can reach PDS internally)\n- A shared HMAC secret for signed callbacks\n- The sidecar has access to the PDS's `OAuthProvider` instance (same process or via internal API)\n\n## Key Concerns\n- **Existing users:** Users who created accounts with passwords can still log in — the sidecar should check if an email exists in the PDS and authenticate accordingly. Password reset flow (`com.atproto.server.resetPassword`) must remain available as a recovery path.\n- **DNS:** Need wildcard DNS for handle resolution (`*.pds.certs.network`) plus the auth subdomain\n- **TLS:** Caddy handles automatic TLS via Let's Encrypt. Need DNS challenge for wildcard certs.\n- **Email deliverability:** SPF/DKIM/DMARC records on the sending domain. Use a reputable SMTP provider.\n- **Monitoring:** Health checks, structured logging (pino), basic metrics endpoint\n\n## Success Criteria\n- Docker Compose stack starts cleanly with PDS + sidecar + Caddy\n- OAuth metadata at `/.well-known/oauth-authorization-server` shows sidecar's `authorization_endpoint`\n- Complete login flow works from scaffold app to PDS and back\n- OTP emails are delivered reliably\n- Existing password-based users can still authenticate\n- TLS works on all endpoints\n- Health checks pass for all services","status":"open","priority":1,"issue_type":"epic","owner":"sharfy-test.climateai.org","created_at":"2026-02-17T18:12:26.180448+08:00","created_by":"sharfy-test.climateai.org","updated_at":"2026-02-17T18:12:26.180448+08:00","labels":["scope:medium"]}
{"id":"hypercerts-0yp.1","title":"Create Docker Compose stack with Caddy, PDS, and sidecar","description":"## Files\n- docker-compose.yml (create)\n- Dockerfile.pds (create)\n- Dockerfile.auth (create)\n- Caddyfile (create)\n- .env.example (create)\n\n## What to do\nCreate the Docker Compose deployment configuration for the complete PDS + sidecar stack.\n\n### `docker-compose.yml`\nThree services:\n\n#### `caddy`\n- Image: `caddy:2-alpine`\n- Ports: 80, 443\n- Volumes: `./Caddyfile:/etc/caddy/Caddyfile`, `caddy_data:/data`, `caddy_config:/config`\n- Depends on: pds, auth\n\n#### `pds`\n- Build: `Dockerfile.pds`\n- Port: 3000 (internal only, not exposed to host)\n- Volumes: `pds_data:/data` (for SQLite + blobs)\n- Environment: all PDS env vars from .env\n- Health check: `curl -f http://localhost:3000/xrpc/_health`\n\n#### `auth`\n- Build: `Dockerfile.auth`\n- Port: 3001 (internal only)\n- Volumes: `auth_data:/data` (for sidecar SQLite)\n- Environment: auth service env vars from .env\n- Health check: `curl -f http://localhost:3001/health`\n- Depends on: pds\n\n### `Caddyfile`\n```\npds.certs.network {\n    reverse_proxy pds:3000\n}\n\nauth.pds.certs.network {\n    reverse_proxy auth:3001\n}\n\n*.pds.certs.network {\n    reverse_proxy pds:3000\n}\n```\nUse on-demand TLS or DNS challenge for wildcard certs (configure via env var for the DNS provider).\n\n### Dockerfiles\nBoth should be multi-stage builds:\n1. Stage 1: `node:20-alpine` — install deps, build TypeScript\n2. Stage 2: `node:20-alpine` — copy built files, run with `node dist/index.js`\n\n### `.env.example`\nDocument all required environment variables with comments:\n- PDS config (hostname, admin password, PLC URL, etc.)\n- Auth service config (SMTP host/port/user/pass, from address)\n- Shared config (CALLBACK_SECRET)\n- Caddy config (DNS provider API key for wildcard certs)\n\n## Don't\n- Don't include actual secrets in any committed file\n- Don't expose PDS or auth ports directly to the host (only through Caddy)\n- Don't use `latest` tags for base images — pin versions","acceptance_criteria":"1. `docker compose build` succeeds\n2. `docker compose up` starts all three services\n3. Health checks pass for PDS and auth service\n4. Caddy serves HTTPS on the configured domains\n5. `.env.example` documents all required variables\n6. No secrets are committed to the repository","status":"open","priority":2,"issue_type":"task","owner":"sharfy-test.climateai.org","estimated_minutes":45,"created_at":"2026-02-17T18:16:43.769223+08:00","created_by":"sharfy-test.climateai.org","updated_at":"2026-02-17T18:16:43.769223+08:00","labels":["scope:small"],"dependencies":[{"issue_id":"hypercerts-0yp.1","depends_on_id":"hypercerts-0yp","type":"parent-child","created_at":"2026-02-17T18:16:43.77054+08:00","created_by":"sharfy-test.climateai.org"},{"issue_id":"hypercerts-0yp.1","depends_on_id":"hypercerts-qc3.6","type":"blocks","created_at":"2026-02-17T18:16:43.77197+08:00","created_by":"sharfy-test.climateai.org"},{"issue_id":"hypercerts-0yp.1","depends_on_id":"hypercerts-qc3.7","type":"blocks","created_at":"2026-02-17T18:16:43.772825+08:00","created_by":"sharfy-test.climateai.org"}]}
{"id":"hypercerts-2bf","title":"Epic: Scaffold Email-First Auth UI","description":"## Goal\nBuild a new email-first login page at `/login` in the hypercerts-scaffold Next.js app. This page replaces the handle-based login flow with an email input that initiates ATProto OAuth with the user's email passed as `login_hint`. The old handle-based login (`LoginDialog` component, `SignedInProvider` gate) remains untouched — both flows coexist so we can test the new flow independently.\n\n## Context\nThe scaffold app currently requires users to enter their ATProto handle (e.g., `alice.certified.app`) to log in. This is confusing for non-technical users. We're building email-first passwordless login where users enter their email, receive a 6-digit OTP code, and are authenticated — no handles, no passwords.\n\nThe scaffold's role is the **client side** of this flow. A separate PDS sidecar service (different repo) handles the server-side OTP generation/verification. The scaffold just needs to:\n1. Collect the user's email\n2. Pass it as `login_hint` in the ATProto OAuth authorization URL\n3. Handle the standard OAuth callback (unchanged)\n\nThe PDS sidecar intercepts the OAuth authorization endpoint and uses the `login_hint` to send an OTP email immediately, so the user sees an OTP input (not a password form) at the PDS.\n\n## Technical Background\n- **Framework:** Next.js 16 with App Router\n- **Current auth flow:** User enters handle → POST `/api/auth/login` → `sdk.authorize(handle)` → redirect to PDS → password form → callback → session cookie\n- **New auth flow:** User enters email → POST `/api/auth/login` with email + `login_hint` → `sdk.authorize(pdsUrl, { login_hint: email })` → redirect to PDS sidecar → OTP form → callback → session cookie\n- **Key files:** `components/login-dialog.tsx`, `app/api/auth/login/route.ts`, `lib/config.ts`, `lib/hypercerts-sdk.ts`, `providers/SignedInProvider.tsx`\n- **UI components available:** shadcn/ui (Button, Input, Card, InputGroup, Spinner, etc.), Tailwind CSS, fonts: Syne (headings), Outfit (body)\n- **SDK:** `@hypercerts-org/sdk-core` wraps `@atproto/oauth-client-node`. The `sdk.authorize()` method accepts a handle, DID, or PDS URL.\n\n## Success Criteria\n- New `/login` page exists with email input and unified sign-in/sign-up flow\n- Email is passed as `login_hint` through the OAuth flow\n- Old handle-based login still works at the root (SignedInProvider + LoginDialog unchanged)\n- OAuth callback handles both flows identically\n- No new environment variables required (uses existing `NEXT_PUBLIC_PDS_URL`)","status":"open","priority":1,"issue_type":"epic","owner":"sharfy-test.climateai.org","created_at":"2026-02-17T18:11:29.861164+08:00","created_by":"sharfy-test.climateai.org","updated_at":"2026-02-17T18:11:29.861164+08:00","labels":["scope:medium"]}
{"id":"hypercerts-2bf.1","title":"Create /login page with email input form","description":"## Files\n- app/login/page.tsx (create)\n- components/email-login-form.tsx (create)\n\n## What to do\nCreate a new Next.js App Router page at `/login` with an email-first login form. This page exists alongside the old handle-based login (which remains at the root via `SignedInProvider`).\n\n### Page: `app/login/page.tsx`\n- Server component that checks for an existing session (same pattern as `SignedInProvider`)\n- If already authenticated, redirect to `/` using `redirect()` from `next/navigation`\n- If not authenticated, render the `EmailLoginForm` component centered on screen\n- Include the `Navbar` with `isSignedIn={false}` (same pattern as SignedInProvider's unauthenticated state)\n\n### Component: `components/email-login-form.tsx`\n- Client component (`'use client'`)\n- Single form with one email input field and a submit button\n- Heading: 'Sign In' (font: Syne, bold)\n- Subheading: 'Enter your email to continue' (font: Outfit, muted)\n- Email input: standard `\u003cInput\u003e` from `components/ui/input.tsx`, type='email', placeholder='you@example.com', required\n- Submit button: 'Continue' text, full width, uses `bg-create-accent` styling (same as existing LoginDialog)\n- Loading state: show `\u003cSpinner\u003e` in button when submitting, disable button\n- On submit: call `useEmailLoginMutation` (created in a separate task) which POSTs to `/api/auth/email-login`\n- Error state: show error message below the form if mutation fails (use `text-destructive` class)\n- Match the visual style of the existing `LoginDialog` component (same fonts, colors, spacing, `animate-fade-in-up` animations)\n\n### Layout\n- The form should be centered vertically and horizontally, max-width `sm` (same as LoginDialog)\n- Wrap in a `\u003cdiv className='flex grow flex-col items-center justify-center'\u003e` (same pattern as SignedInProvider)\n\n## Don't\n- Don't modify `SignedInProvider`, `LoginDialog`, or any existing auth components\n- Don't add any new environment variables\n- Don't implement the API route or mutation hook (those are separate tasks)\n- Don't add OTP verification UI (that's handled by the PDS sidecar, not the scaffold)\n- Don't add a layout.tsx for /login — use the root layout","acceptance_criteria":"1. Visiting /login when not authenticated shows a centered form with email input and 'Continue' button\n2. Visiting /login when authenticated redirects to /\n3. The form validates email format (HTML5 type=email)\n4. The form shows a loading spinner when submitting\n5. The existing LoginDialog at the root route still works unchanged\n6. No TypeScript errors (npx tsc --noEmit passes)\n7. The page renders without errors in the browser","status":"closed","priority":1,"issue_type":"task","assignee":"sharfy-test.climateai.org","owner":"sharfy-test.climateai.org","estimated_minutes":30,"created_at":"2026-02-17T18:12:49.415659+08:00","created_by":"sharfy-test.climateai.org","updated_at":"2026-02-17T18:39:42.193719+08:00","closed_at":"2026-02-17T18:39:42.193719+08:00","close_reason":"062b00d Create /login page with email input form","labels":["scope:small"],"dependencies":[{"issue_id":"hypercerts-2bf.1","depends_on_id":"hypercerts-2bf","type":"parent-child","created_at":"2026-02-17T18:12:49.416938+08:00","created_by":"sharfy-test.climateai.org"},{"issue_id":"hypercerts-2bf.1","depends_on_id":"hypercerts-2bf.2","type":"blocks","created_at":"2026-02-17T18:13:31.992691+08:00","created_by":"sharfy-test.climateai.org"}]}
{"id":"hypercerts-2bf.2","title":"Create useEmailLoginMutation hook and API client function","description":"## Files\n- queries/auth/use-email-login-mutation.ts (create)\n- queries/auth/index.ts (modify)\n- lib/api/auth.ts (modify)\n- lib/api/types.ts (modify)\n\n## What to do\nCreate the client-side mutation hook and API function for the email-first login flow. This follows the exact same pattern as the existing `useLoginMutation` / `login()` but accepts an email instead of a handle.\n\n### `lib/api/types.ts` — Add types\nAdd alongside existing types:\n```typescript\nexport interface EmailLoginRequest {\n  email: string;\n}\n\nexport interface EmailLoginResponse {\n  authUrl: string;\n}\n```\n\n### `lib/api/auth.ts` — Add API function\nAdd a new function alongside the existing `login()`:\n```typescript\nexport async function emailLogin(email: string): Promise\u003cEmailLoginResponse\u003e {\n  return apiClient.post\u003cEmailLoginResponse\u003e('/api/auth/email-login', { email });\n}\n```\nThe existing `login()` and `logout()` functions must remain unchanged.\n\n### `queries/auth/use-email-login-mutation.ts` — Create mutation hook\nFollow the exact pattern of `use-login-mutation.ts`:\n- Import `emailLogin` from `@/lib/api/auth`\n- Use `useMutation` from `@tanstack/react-query`\n- `mutationFn`: calls `emailLogin(email)`\n- `onSuccess`: calls `router.push(data.authUrl)` to redirect to the PDS/sidecar authorization page (same as useLoginMutation)\n- `onError`: log error to console (same as useLoginMutation)\n- Export as `useEmailLoginMutation`\n\n### `queries/auth/index.ts` — Re-export\nAdd `export { useEmailLoginMutation } from './use-email-login-mutation'` alongside existing exports.\n\n## Don't\n- Don't modify the existing `useLoginMutation` or `login()` function\n- Don't implement the server-side API route (that's a separate task)\n- Don't add error handling beyond what the existing hooks do","acceptance_criteria":"1. `useEmailLoginMutation` is exported from `queries/auth/index.ts`\n2. Calling `mutation.mutate('user@example.com')` POSTs to `/api/auth/email-login` with `{ email: 'user@example.com' }`\n3. On success, the browser navigates to the returned `authUrl`\n4. The existing `useLoginMutation` and `useLogoutMutation` still work unchanged\n5. No TypeScript errors (npx tsc --noEmit passes)","status":"closed","priority":1,"issue_type":"task","assignee":"sharfy-test.climateai.org","owner":"sharfy-test.climateai.org","estimated_minutes":20,"created_at":"2026-02-17T18:13:03.438072+08:00","created_by":"sharfy-test.climateai.org","updated_at":"2026-02-17T18:35:38.217518+08:00","closed_at":"2026-02-17T18:35:38.217518+08:00","close_reason":"0ce88fd Add useEmailLoginMutation hook and emailLogin API function","labels":["scope:small"],"dependencies":[{"issue_id":"hypercerts-2bf.2","depends_on_id":"hypercerts-2bf","type":"parent-child","created_at":"2026-02-17T18:13:03.43898+08:00","created_by":"sharfy-test.climateai.org"}]}
{"id":"hypercerts-2bf.3","title":"Create /api/auth/email-login API route with login_hint passthrough","description":"## Files\n- app/api/auth/email-login/route.ts (create)\n\n## What to do\nCreate a new Next.js API route that accepts an email address and initiates the ATProto OAuth flow with the email passed as `login_hint`. This is the server-side counterpart to the `useEmailLoginMutation` hook.\n\n### Route: `POST /api/auth/email-login`\n\n**Request body:**\n```json\n{ \"email\": \"user@example.com\" }\n```\n\n**Logic:**\n1. Parse the request body and extract `email`\n2. Validate that `email` is present and is a valid email format (basic regex or just check for `@`)\n3. Call `sdk.authorize()` to initiate the OAuth flow. The key difference from the existing `/api/auth/login` route is:\n   - Pass the **PDS URL** (from `config.pdsUrl`, i.e., `process.env.NEXT_PUBLIC_PDS_URL`) as the first argument — NOT the email. The PDS URL tells the SDK which authorization server to use.\n   - Pass the email as `login_hint` in the authorization URL. The `@atproto/oauth-client-node` SDK's `authorize()` method may not directly support `login_hint` as a parameter. If it doesn't, you need to:\n     a. First try: check if `sdk.authorize(pdsUrl, { login_hint: email })` works (check the SDK types)\n     b. If not: get the authorization URL from `sdk.authorize(pdsUrl)` and append `\u0026login_hint=${encodeURIComponent(email)}` to the URL before returning it\n4. Return `{ authUrl: \u003cthe authorization URL\u003e }` as JSON\n\n**Response (success):**\n```json\n{ \"authUrl\": \"https://pds.certs.network/oauth/authorize?...\u0026login_hint=user%40example.com\" }\n```\n\n**Response (error):**\n```json\n{ \"error\": \"Email is required\" }  // 400\n{ \"error\": \"Failed to initiate login process\" }  // 500\n```\n\n### Important: Understanding `sdk.authorize()`\nThe existing login route calls `sdk.authorize(handle)` where `handle` is a user's ATProto handle (e.g., `alice.bsky.social`). The SDK resolves the handle to find the user's PDS/authorization server.\n\nFor email login, we don't have a handle — we have an email. We know the PDS URL (`NEXT_PUBLIC_PDS_URL`), so we pass that directly. The SDK will use it to find the authorization server. The `login_hint` parameter is an OAuth standard parameter that the authorization server (our sidecar) will use to pre-fill the email and send the OTP immediately.\n\n### Reference: Existing login route\n```typescript\n// app/api/auth/login/route.ts (DO NOT MODIFY)\nimport sdk from '@/lib/hypercerts-sdk';\nexport async function POST(request: Request) {\n  const body = await request.json();\n  const handle = body.handle;\n  try {\n    const authUrl = await sdk.authorize(handle);\n    return NextResponse.json({ authUrl });\n  } catch (e) {\n    console.error('Failed to initiate login process', e);\n    return Response.json({ error: 'Failed to initiate login process' }, { status: 500 });\n  }\n}\n```\n\n## Don't\n- Don't modify the existing `/api/auth/login` route\n- Don't modify the existing `/api/auth/callback` route (the callback is the same for both flows)\n- Don't add new environment variables\n- Don't try to resolve email→handle or email→DID on the scaffold side (that's the sidecar's job)","acceptance_criteria":"1. POST /api/auth/email-login with `{ email: 'user@example.com' }` returns `{ authUrl: '...' }` with status 200\n2. The returned authUrl contains `login_hint=user%40example.com` (or equivalent encoding)\n3. POST /api/auth/email-login with empty body returns 400 with error message\n4. POST /api/auth/email-login with `{ email: '' }` returns 400 with error message\n5. The existing /api/auth/login route still works unchanged\n6. The existing /api/auth/callback route handles callbacks from both flows (no changes needed)\n7. No TypeScript errors (npx tsc --noEmit passes)","status":"closed","priority":1,"issue_type":"task","assignee":"sharfy-test.climateai.org","owner":"sharfy-test.climateai.org","estimated_minutes":30,"created_at":"2026-02-17T18:13:26.675271+08:00","created_by":"sharfy-test.climateai.org","updated_at":"2026-02-17T18:35:41.084402+08:00","closed_at":"2026-02-17T18:35:41.084402+08:00","close_reason":"c42b281 Create /api/auth/email-login route with login_hint passthrough","labels":["scope:small"],"dependencies":[{"issue_id":"hypercerts-2bf.3","depends_on_id":"hypercerts-2bf","type":"parent-child","created_at":"2026-02-17T18:13:26.675986+08:00","created_by":"sharfy-test.climateai.org"}]}
{"id":"hypercerts-97q","title":"Epic: Email-First Passwordless Login UI","description":"## Goal\nReplace the handle-centric login UX with an email-first, passwordless experience that:\n- Collects email (not handle) as the primary identifier\n- Works seamlessly when the PDS supports email OTP (Phase 2, separate repo)\n- Degrades gracefully to handle-based OAuth when the PDS still requires passwords\n- Moves auth from inline dialogs/popovers to dedicated /auth/* pages\n- Supports the cross-app Certified identity model (email as the user-facing identity)\n\n## Context\nThe product spec requires email-first passwordless login for Ma Earth's grants round and the broader Certified ecosystem. The PDS at pds-eu-west4.test.certified.app will be modified separately (see holkexyz/atproto magic-pds for reference implementation). This epic covers only the scaffold-side changes — building the UI, adapting the OAuth flow entry point, and restructuring auth state management.\n\n## Scope\n- IN: New /auth/* pages (signin, verify), auth layout, entryway client, modified login API route, refactored SignedInProvider, updated navbar, cleanup of old login components, config changes\n- OUT: PDS modifications, entryway service, email sending infrastructure, OTP generation/validation (all PDS-side), TOTP/passkey support (future epic)\n\n## Key Constraints\n- The ATProto OAuth flow (PKCE + DPoP) MUST remain functional — it is the only way to get PDS write tokens\n- Redis session/state stores MUST NOT be removed — the ATProto SDK requires them\n- The app/client-metadata.json and app/jwks.json routes MUST NOT be deleted — they are required for ATProto OAuth even with email-first UI\n- Feature flag (NEXT_PUBLIC_ENTRYWAY_URL) controls whether email resolution is attempted; when absent, falls back to handle input\n- All new pages use existing shadcn/ui components and Tailwind CSS v4\n- No new runtime dependencies except the entryway HTTP client (plain fetch)","status":"tombstone","priority":1,"issue_type":"epic","assignee":"sharfy-test.climateai.org","owner":"sharfy-test.climateai.org","created_at":"2026-02-17T15:38:46.019886+08:00","created_by":"sharfy-test.climateai.org","updated_at":"2026-02-17T15:39:18.298716+08:00","labels":["scope:medium"],"deleted_at":"2026-02-17T15:39:18.298716+08:00","deleted_by":"daemon","delete_reason":"delete","original_type":"epic"}
{"id":"hypercerts-jw5","title":"Epic: Remove all SDS references and organization features","description":"Remove all Shared Data Server (SDS) infrastructure and organization-related features from the codebase. This includes environment configuration, type definitions, organization pages/components/queries, profile switching, and all related documentation. The application will only support PDS (Personal Data Server) going forward.","status":"closed","priority":1,"issue_type":"epic","assignee":"kzoeps","owner":"kzoepa@gmail.com","created_at":"2026-02-13T10:57:19.625374856+06:00","created_by":"kzoeps","updated_at":"2026-02-13T11:08:54.570180551+06:00","closed_at":"2026-02-13T11:08:54.570180551+06:00","close_reason":"Completed: All SDS references and organization features removed"}
{"id":"hypercerts-jw5.1","title":"Remove SDS from environment configuration","description":"Remove NEXT_PUBLIC_SDS_URL environment variable from .env.example and .env.local. Remove sdsUrl field and validation from lib/config.ts (lines 194, 210, 236). Files affected: .env.example (lines 52-53), .env.local (line 20), lib/config.ts (lines 194, 210, 236).","status":"closed","priority":1,"issue_type":"task","assignee":"kzoeps","owner":"kzoepa@gmail.com","created_at":"2026-02-13T10:57:25.0772292+06:00","created_by":"kzoeps","updated_at":"2026-02-13T11:01:21.906727001+06:00","closed_at":"2026-02-13T11:01:21.906727001+06:00","close_reason":"Completed: 970322f3161f84168f0130778997293b3c3cc853","dependencies":[{"issue_id":"hypercerts-jw5.1","depends_on_id":"hypercerts-jw5","type":"parent-child","created_at":"2026-02-13T10:57:25.078964487+06:00","created_by":"kzoeps"}]}
{"id":"hypercerts-jw5.10","title":"Remove profile switching dialog","description":"Delete components/profile-switch-dialog.tsx entirely. Remove this component from any layouts or pages that import it (likely in app/layout.tsx or similar). Remove the SignedInProvider usage from providers/SignedInProvider.tsx (line 27) that fetches organization data with getAuthenticatedRepo('sds'). This task depends on hypercerts-jw5.3 (session management) because the provider uses serverOverride.","status":"closed","priority":1,"issue_type":"task","assignee":"kzoeps","owner":"kzoepa@gmail.com","created_at":"2026-02-13T10:58:14.830834235+06:00","created_by":"kzoeps","updated_at":"2026-02-13T11:06:47.965297704+06:00","closed_at":"2026-02-13T11:06:47.965297704+06:00","close_reason":"Completed: af38f1b","dependencies":[{"issue_id":"hypercerts-jw5.10","depends_on_id":"hypercerts-jw5","type":"parent-child","created_at":"2026-02-13T10:58:14.832712721+06:00","created_by":"kzoeps"},{"issue_id":"hypercerts-jw5.10","depends_on_id":"hypercerts-jw5.3","type":"blocks","created_at":"2026-02-13T10:58:36.962725875+06:00","created_by":"kzoeps"}]}
{"id":"hypercerts-jw5.11","title":"Update repo context to handle PDS only","description":"Simplify lib/repo-context.ts to only handle PDS. Remove the server determination logic at line 61 (targetDid === userDid ? 'pds' : 'sds'). Remove RepoServer type field from interfaces if no longer needed. This task depends on hypercerts-jw5.2 (type definitions) and hypercerts-jw5.3 (session management) because we need the core types and session logic updated first.","status":"closed","priority":1,"issue_type":"task","assignee":"kzoeps","owner":"kzoepa@gmail.com","created_at":"2026-02-13T10:58:20.278269871+06:00","created_by":"kzoeps","updated_at":"2026-02-13T11:06:32.355814639+06:00","closed_at":"2026-02-13T11:06:32.355814639+06:00","close_reason":"Completed: 024d9b8b1dfe9cd5b49a45aeb7cae96cc95e2667","dependencies":[{"issue_id":"hypercerts-jw5.11","depends_on_id":"hypercerts-jw5","type":"parent-child","created_at":"2026-02-13T10:58:20.279708313+06:00","created_by":"kzoeps"},{"issue_id":"hypercerts-jw5.11","depends_on_id":"hypercerts-jw5.2","type":"blocks","created_at":"2026-02-13T10:58:37.013357307+06:00","created_by":"kzoeps"},{"issue_id":"hypercerts-jw5.11","depends_on_id":"hypercerts-jw5.3","type":"blocks","created_at":"2026-02-13T10:58:37.06325177+06:00","created_by":"kzoeps"}]}
{"id":"hypercerts-jw5.12","title":"Clean up organization query keys","description":"Remove organization-related query key definitions from lib/api/query-keys.ts (lines 41-48). This task depends on hypercerts-jw5.7 (delete organization queries) because we need to ensure no queries are using these keys before removing them.","status":"closed","priority":1,"issue_type":"task","assignee":"kzoeps","owner":"kzoepa@gmail.com","created_at":"2026-02-13T10:58:24.864366819+06:00","created_by":"kzoeps","updated_at":"2026-02-13T11:05:14.468657802+06:00","closed_at":"2026-02-13T11:05:14.468657802+06:00","close_reason":"Completed: 2e96aef","dependencies":[{"issue_id":"hypercerts-jw5.12","depends_on_id":"hypercerts-jw5","type":"parent-child","created_at":"2026-02-13T10:58:24.866971645+06:00","created_by":"kzoeps"},{"issue_id":"hypercerts-jw5.12","depends_on_id":"hypercerts-jw5.7","type":"blocks","created_at":"2026-02-13T10:58:37.11335342+06:00","created_by":"kzoeps"}]}
{"id":"hypercerts-jw5.13","title":"Update README to remove SDS documentation","description":"Remove all SDS references from README.md: line 10 (PDS/SDS account mention), line 45 (environment variable table entry), line 63 (test server URL example), lines 119-127 (architecture diagram and PDS vs SDS explanation), line 196 (organizations on SDS mention), line 254 (link to SDS GitHub repo). Update documentation to reflect PDS-only architecture. This task depends on all previous tasks (hypercerts-jw5.1 through hypercerts-jw5.12) because documentation should be updated last after all code changes are complete.","status":"closed","priority":1,"issue_type":"task","assignee":"kzoeps","owner":"kzoepa@gmail.com","created_at":"2026-02-13T10:58:31.437345428+06:00","created_by":"kzoeps","updated_at":"2026-02-13T11:08:36.620756909+06:00","closed_at":"2026-02-13T11:08:36.620756909+06:00","close_reason":"Completed: README already updated by previous commits","dependencies":[{"issue_id":"hypercerts-jw5.13","depends_on_id":"hypercerts-jw5","type":"parent-child","created_at":"2026-02-13T10:58:31.438988373+06:00","created_by":"kzoeps"},{"issue_id":"hypercerts-jw5.13","depends_on_id":"hypercerts-jw5.1","type":"blocks","created_at":"2026-02-13T10:58:42.980883411+06:00","created_by":"kzoeps"},{"issue_id":"hypercerts-jw5.13","depends_on_id":"hypercerts-jw5.2","type":"blocks","created_at":"2026-02-13T10:58:43.031383969+06:00","created_by":"kzoeps"},{"issue_id":"hypercerts-jw5.13","depends_on_id":"hypercerts-jw5.3","type":"blocks","created_at":"2026-02-13T10:58:43.083619404+06:00","created_by":"kzoeps"},{"issue_id":"hypercerts-jw5.13","depends_on_id":"hypercerts-jw5.4","type":"blocks","created_at":"2026-02-13T10:58:43.135155641+06:00","created_by":"kzoeps"},{"issue_id":"hypercerts-jw5.13","depends_on_id":"hypercerts-jw5.5","type":"blocks","created_at":"2026-02-13T10:58:43.197015061+06:00","created_by":"kzoeps"},{"issue_id":"hypercerts-jw5.13","depends_on_id":"hypercerts-jw5.6","type":"blocks","created_at":"2026-02-13T10:58:43.246763992+06:00","created_by":"kzoeps"},{"issue_id":"hypercerts-jw5.13","depends_on_id":"hypercerts-jw5.7","type":"blocks","created_at":"2026-02-13T10:58:43.295935142+06:00","created_by":"kzoeps"},{"issue_id":"hypercerts-jw5.13","depends_on_id":"hypercerts-jw5.8","type":"blocks","created_at":"2026-02-13T10:58:43.345300956+06:00","created_by":"kzoeps"},{"issue_id":"hypercerts-jw5.13","depends_on_id":"hypercerts-jw5.9","type":"blocks","created_at":"2026-02-13T10:58:43.395508806+06:00","created_by":"kzoeps"},{"issue_id":"hypercerts-jw5.13","depends_on_id":"hypercerts-jw5.10","type":"blocks","created_at":"2026-02-13T10:58:43.443782516+06:00","created_by":"kzoeps"},{"issue_id":"hypercerts-jw5.13","depends_on_id":"hypercerts-jw5.11","type":"blocks","created_at":"2026-02-13T10:58:43.492942164+06:00","created_by":"kzoeps"},{"issue_id":"hypercerts-jw5.13","depends_on_id":"hypercerts-jw5.12","type":"blocks","created_at":"2026-02-13T10:58:43.545747096+06:00","created_by":"kzoeps"}]}
{"id":"hypercerts-jw5.2","title":"Update type definitions to remove SDS","description":"Change RepoServer type from 'pds' | 'sds' to just 'pds' in lib/repo-context.ts (line 8). Remove serverOverride parameter type that includes 'sds' from lib/atproto-session.ts (line 8). Update all type usage to reflect PDS-only infrastructure. Files affected: lib/repo-context.ts (lines 8, 23, 30, 61), lib/atproto-session.ts (lines 8, 19).","status":"closed","priority":1,"issue_type":"task","assignee":"kzoeps","owner":"kzoepa@gmail.com","created_at":"2026-02-13T10:57:31.387671487+06:00","created_by":"kzoeps","updated_at":"2026-02-13T11:01:52.916414734+06:00","closed_at":"2026-02-13T11:01:52.916414734+06:00","close_reason":"Completed: 7cb57ff4f0e9545e9fd8b27d194de5236d269061","dependencies":[{"issue_id":"hypercerts-jw5.2","depends_on_id":"hypercerts-jw5","type":"parent-child","created_at":"2026-02-13T10:57:31.390035933+06:00","created_by":"kzoeps"}]}
{"id":"hypercerts-jw5.3","title":"Simplify session management by removing SDS logic","description":"Remove serverOverride parameter from getAuthenticatedRepo function in lib/atproto-session.ts (line 8). Remove server determination logic that defaults organizations to SDS (lines 19-26). Simplify to always use PDS. Remove comment about SDS default for organizations (line 23). This task depends on hypercerts-jw5.2 (type definition updates) because we need the types updated first.","status":"closed","priority":1,"issue_type":"task","assignee":"kzoeps","owner":"kzoepa@gmail.com","created_at":"2026-02-13T10:57:36.812241339+06:00","created_by":"kzoeps","updated_at":"2026-02-13T11:03:28.27736993+06:00","closed_at":"2026-02-13T11:03:28.27736993+06:00","close_reason":"Completed: f904aed717e18e851fcd2d6e590836fa9b7dc689","dependencies":[{"issue_id":"hypercerts-jw5.3","depends_on_id":"hypercerts-jw5","type":"parent-child","created_at":"2026-02-13T10:57:36.814164408+06:00","created_by":"kzoeps"},{"issue_id":"hypercerts-jw5.3","depends_on_id":"hypercerts-jw5.2","type":"blocks","created_at":"2026-02-13T10:58:36.651339481+06:00","created_by":"kzoeps"}]}
{"id":"hypercerts-jw5.4","title":"Update SDK initialization to remove SDS","description":"Remove 'sds: config.sdsUrl' from SDK server configuration in lib/hypercerts-sdk.ts (line 39). Update SDK initialization to only use PDS. This task depends on hypercerts-jw5.1 (environment config removal) because we need config.sdsUrl removed first.","status":"closed","priority":1,"issue_type":"task","assignee":"kzoeps","owner":"kzoepa@gmail.com","created_at":"2026-02-13T10:57:41.609155705+06:00","created_by":"kzoeps","updated_at":"2026-02-13T11:03:51.936722151+06:00","closed_at":"2026-02-13T11:03:51.936722151+06:00","close_reason":"Completed: 0ee8d8c967f42b720a0203022ce99e33647cb12a","dependencies":[{"issue_id":"hypercerts-jw5.4","depends_on_id":"hypercerts-jw5","type":"parent-child","created_at":"2026-02-13T10:57:41.611008192+06:00","created_by":"kzoeps"},{"issue_id":"hypercerts-jw5.4","depends_on_id":"hypercerts-jw5.1","type":"blocks","created_at":"2026-02-13T10:58:36.701434689+06:00","created_by":"kzoeps"}]}
{"id":"hypercerts-jw5.5","title":"Delete organization pages","description":"Delete the entire app/organizations/ directory, which includes: page.tsx (organization list), [orgDid]/page.tsx (organization detail), create/page.tsx (create organization), create/layout.tsx, loading.tsx, and [orgDid]/loading.tsx. This task depends on hypercerts-jw5.3 (session management simplification) because those files use the serverOverride parameter that will be removed.","status":"closed","priority":1,"issue_type":"task","assignee":"kzoeps","owner":"kzoepa@gmail.com","created_at":"2026-02-13T10:57:46.81007388+06:00","created_by":"kzoeps","updated_at":"2026-02-13T11:04:11.172066695+06:00","closed_at":"2026-02-13T11:04:11.172066695+06:00","close_reason":"Completed: 3428fe02f55fe17c9193be3d78e01b24903474a5","dependencies":[{"issue_id":"hypercerts-jw5.5","depends_on_id":"hypercerts-jw5","type":"parent-child","created_at":"2026-02-13T10:57:46.811920897+06:00","created_by":"kzoeps"},{"issue_id":"hypercerts-jw5.5","depends_on_id":"hypercerts-jw5.3","type":"blocks","created_at":"2026-02-13T10:58:36.75669208+06:00","created_by":"kzoeps"}]}
{"id":"hypercerts-jw5.6","title":"Delete organization components","description":"Delete organization-related components: components/organization-form.tsx, components/organization-detail-view.tsx, components/organization-creation-success.tsx, components/collaborators-list-view.tsx, components/add-contributors-form.tsx. Remove any imports of these components from other files. This task can run in parallel with hypercerts-jw5.5 (delete pages) since they are independent.","status":"closed","priority":1,"issue_type":"task","assignee":"kzoeps","owner":"kzoepa@gmail.com","created_at":"2026-02-13T10:57:52.089516982+06:00","created_by":"kzoeps","updated_at":"2026-02-13T11:02:17.815171991+06:00","closed_at":"2026-02-13T11:02:17.815171991+06:00","close_reason":"Completed: 4299fe74ca5d3a6bc7dcd16db4478e21495c7e5c","dependencies":[{"issue_id":"hypercerts-jw5.6","depends_on_id":"hypercerts-jw5","type":"parent-child","created_at":"2026-02-13T10:57:52.091170987+06:00","created_by":"kzoeps"}]}
{"id":"hypercerts-jw5.7","title":"Delete organization queries","description":"Delete the entire queries/organizations/ directory, which includes use-check-handle-query.ts and index.ts. Also remove checkHandleAvailability function from lib/api/external/bluesky.ts (lines 42-60) that checks handle availability on SDS server. This task can run in parallel with hypercerts-jw5.5 and hypercerts-jw5.6.","status":"closed","priority":1,"issue_type":"task","assignee":"kzoeps","owner":"kzoepa@gmail.com","created_at":"2026-02-13T10:57:57.491629768+06:00","created_by":"kzoeps","updated_at":"2026-02-13T11:02:44.401504275+06:00","closed_at":"2026-02-13T11:02:44.401504275+06:00","close_reason":"Completed: f20bf2f4eb234d67c9e06a9b71b103be938c90f9","dependencies":[{"issue_id":"hypercerts-jw5.7","depends_on_id":"hypercerts-jw5","type":"parent-child","created_at":"2026-02-13T10:57:57.493747823+06:00","created_by":"kzoeps"}]}
{"id":"hypercerts-jw5.8","title":"Remove organization operations from create-actions","description":"Remove organization-related functions from lib/create-actions.ts: lines 202 (create org with serverOverride), 214 (add collaborators), 232 (remove collaborators), 246 (list organizations). This task depends on hypercerts-jw5.3 (session management) because these functions use serverOverride parameter.","status":"closed","priority":1,"issue_type":"task","assignee":"kzoeps","owner":"kzoepa@gmail.com","created_at":"2026-02-13T10:58:02.724974343+06:00","created_by":"kzoeps","updated_at":"2026-02-13T11:07:24.646163697+06:00","closed_at":"2026-02-13T11:07:24.646163697+06:00","close_reason":"Completed: 8b6439f","dependencies":[{"issue_id":"hypercerts-jw5.8","depends_on_id":"hypercerts-jw5","type":"parent-child","created_at":"2026-02-13T10:58:02.726703099+06:00","created_by":"kzoeps"},{"issue_id":"hypercerts-jw5.8","depends_on_id":"hypercerts-jw5.3","type":"blocks","created_at":"2026-02-13T10:58:36.812943121+06:00","created_by":"kzoeps"}]}
{"id":"hypercerts-jw5.9","title":"Simplify blob utilities to remove SDS URL handling","description":"Remove SDS URL handling from lib/blob-utils.ts (line 25) - simplify blob URL resolution to only use PDS. Remove SDS URL usage from app/hypercerts/[hypercertUri]/page.tsx (line 86) for image blob resolution. This task depends on hypercerts-jw5.1 (environment config) and hypercerts-jw5.5 (delete org pages) because we need config cleaned up and no org pages referencing blobs.","status":"closed","priority":1,"issue_type":"task","assignee":"kzoeps","owner":"kzoepa@gmail.com","created_at":"2026-02-13T10:58:09.274201803+06:00","created_by":"kzoeps","updated_at":"2026-02-13T11:07:42.730303409+06:00","closed_at":"2026-02-13T11:07:42.730303409+06:00","close_reason":"Completed: Already cleaned up in previous commits","dependencies":[{"issue_id":"hypercerts-jw5.9","depends_on_id":"hypercerts-jw5","type":"parent-child","created_at":"2026-02-13T10:58:09.276322082+06:00","created_by":"kzoeps"},{"issue_id":"hypercerts-jw5.9","depends_on_id":"hypercerts-jw5.1","type":"blocks","created_at":"2026-02-13T10:58:36.863175646+06:00","created_by":"kzoeps"},{"issue_id":"hypercerts-jw5.9","depends_on_id":"hypercerts-jw5.5","type":"blocks","created_at":"2026-02-13T10:58:36.913677646+06:00","created_by":"kzoeps"}]}
{"id":"hypercerts-p9n","title":"Epic: Document SDK Packaging and Enhance Developer Experience","status":"closed","priority":1,"issue_type":"epic","assignee":"kzoeps","owner":"kzoepa@gmail.com","created_at":"2026-02-13T11:18:09.88485984+06:00","created_by":"kzoeps","updated_at":"2026-02-13T11:28:40.447887994+06:00","closed_at":"2026-02-13T11:28:40.447887994+06:00","close_reason":"Completed all 7 documentation tasks: created DEVELOPMENT.md, added SDK warnings, enhanced loopback docs, improved prerequisites, updated .env.example, reorganized footer, and reviewed code examples"}
{"id":"hypercerts-p9n.1","title":"Create DEVELOPMENT.md with SDK version warnings and development guide","description":"Create a comprehensive DEVELOPMENT.md file covering: (1) Critical warning about unreleased SDK version (0.10.0-beta.8 from vendor/), (2) Explanation of packed packages and why we use them for dogfooding, (3) Warning that installing latest SDK may break scaffold, (4) Step-by-step instructions to update vendor SDK package manually, (5) Local development workflow and setup, (6) Contributing guidelines encouraging users to file issues for @kzoeps. This file serves as the technical reference for developers working with the scaffold.","status":"closed","priority":1,"issue_type":"task","assignee":"kzoeps","owner":"kzoepa@gmail.com","created_at":"2026-02-13T11:18:18.009152902+06:00","created_by":"kzoeps","updated_at":"2026-02-13T11:23:15.860547626+06:00","closed_at":"2026-02-13T11:23:15.860547626+06:00","close_reason":"Completed: 5ec8a6e - Created comprehensive DEVELOPMENT.md covering SDK version warnings, packed package explanation, update instructions, development workflow, troubleshooting, and contributing guidelines","dependencies":[{"issue_id":"hypercerts-p9n.1","depends_on_id":"hypercerts-p9n","type":"parent-child","created_at":"2026-02-13T11:18:18.010805084+06:00","created_by":"kzoeps"}]}
{"id":"hypercerts-p9n.2","title":"Add SDK version warning section to README.md","description":"Add a prominent '⚠️ Important: SDK Version \u0026 Breaking Changes' section to README.md immediately after the Quick Start section (around line 32). This section must explain: (1) Uses unreleased v0.10.0-beta.8 from vendor/, (2) Built from github.com/hypercerts-org/hypercerts-sdk not npm, (3) Purpose is dogfooding latest features, (4) Contains unreleased/unmerged changes, (5) Breaking changes expected, (6) Installing latest SDK may break scaffold, (7) Link to DEVELOPMENT.md for details, (8) Link to issues at github.com/hypercerts-org/hypercerts-scaffold-atproto with @kzoeps as maintainer. Depends on hypercerts-p9n.1 because DEVELOPMENT.md must exist to link to it.","status":"closed","priority":1,"issue_type":"task","assignee":"kzoeps","owner":"kzoepa@gmail.com","created_at":"2026-02-13T11:18:25.62233731+06:00","created_by":"kzoeps","updated_at":"2026-02-13T11:23:59.686592067+06:00","closed_at":"2026-02-13T11:23:59.686592067+06:00","close_reason":"Completed: 1e8c516 - Added SDK version warning section to README after Quick Start with all required details","dependencies":[{"issue_id":"hypercerts-p9n.2","depends_on_id":"hypercerts-p9n","type":"parent-child","created_at":"2026-02-13T11:18:25.623979997+06:00","created_by":"kzoeps"},{"issue_id":"hypercerts-p9n.2","depends_on_id":"hypercerts-p9n.1","type":"blocks","created_at":"2026-02-13T11:19:05.137659881+06:00","created_by":"kzoeps"}]}
{"id":"hypercerts-p9n.3","title":"Enhance README loopback configuration documentation","description":"Improve the existing loopback configuration docs in README.md: (1) Make Quick Start note more prominent (line 31) - emphasize OAuth requirement for 127.0.0.1, (2) Add TL;DR to 'Localhost Redirect' section (line 127) explaining that .env.local MUST use 127.0.0.1 for OAuth to work, (3) Add troubleshooting subsection with common OAuth issues (callback failed, invalid redirect_uri, redirect loops, ngrok issues). The loopback docs are already comprehensive, this task just enhances clarity and adds troubleshooting.","status":"closed","priority":2,"issue_type":"task","assignee":"kzoeps","owner":"kzoepa@gmail.com","created_at":"2026-02-13T11:18:33.299950647+06:00","created_by":"kzoeps","updated_at":"2026-02-13T11:24:57.350432049+06:00","closed_at":"2026-02-13T11:24:57.350432049+06:00","close_reason":"Completed: 2a3277f - Enhanced loopback docs with prominent OAuth requirement, TL;DR, and troubleshooting section","dependencies":[{"issue_id":"hypercerts-p9n.3","depends_on_id":"hypercerts-p9n","type":"parent-child","created_at":"2026-02-13T11:18:33.30151496+06:00","created_by":"kzoeps"}]}
{"id":"hypercerts-p9n.4","title":"Improve README prerequisites and installation section","description":"Update Prerequisites section (lines 5-10) in README.md to be more detailed and helpful: (1) Specify Node.js 20+ with nvm recommendation, (2) Mention pnpm explicitly with install command, (3) Expand Redis section with both local Docker and cloud options, (4) Clarify PDS account requirement, (5) Add note referencing DEVELOPMENT.md for SDK details. Update Quick Start section to mention pnpm explicitly and add Redis check before running dev server. Depends on hypercerts-p9n.1 because needs DEVELOPMENT.md to reference it.","status":"closed","priority":2,"issue_type":"task","assignee":"kzoeps","owner":"kzoepa@gmail.com","created_at":"2026-02-13T11:18:41.139193052+06:00","created_by":"kzoeps","updated_at":"2026-02-13T11:25:37.166639803+06:00","closed_at":"2026-02-13T11:25:37.166639803+06:00","close_reason":"Completed: e31646b - Updated prerequisites with detailed requirements and Quick Start with pnpm/Redis clarity","dependencies":[{"issue_id":"hypercerts-p9n.4","depends_on_id":"hypercerts-p9n","type":"parent-child","created_at":"2026-02-13T11:18:41.141044172+06:00","created_by":"kzoeps"},{"issue_id":"hypercerts-p9n.4","depends_on_id":"hypercerts-p9n.1","type":"blocks","created_at":"2026-02-13T11:19:05.725129883+06:00","created_by":"kzoeps"}]}
{"id":"hypercerts-p9n.5","title":"Update .env.example with SDK version reference","description":"Add a header comment block at the top of .env.example file explaining: (1) This scaffold uses unreleased packed SDK version, (2) Reference DEVELOPMENT.md for SDK details and breaking changes, (3) Reference README.md for setup instructions. This provides context for developers when they first copy the file. Depends on hypercerts-p9n.1 because needs DEVELOPMENT.md to reference it.","status":"closed","priority":2,"issue_type":"task","assignee":"kzoeps","owner":"kzoepa@gmail.com","created_at":"2026-02-13T11:18:47.282193967+06:00","created_by":"kzoeps","updated_at":"2026-02-13T11:26:10.199986381+06:00","closed_at":"2026-02-13T11:26:10.199986381+06:00","close_reason":"Completed: 4818387 - Added header comment with SDK version warning and references to DEVELOPMENT.md","dependencies":[{"issue_id":"hypercerts-p9n.5","depends_on_id":"hypercerts-p9n","type":"parent-child","created_at":"2026-02-13T11:18:47.283647269+06:00","created_by":"kzoeps"},{"issue_id":"hypercerts-p9n.5","depends_on_id":"hypercerts-p9n.1","type":"blocks","created_at":"2026-02-13T11:19:06.370792289+06:00","created_by":"kzoeps"}]}
{"id":"hypercerts-p9n.6","title":"Add DEVELOPMENT.md link to README footer","description":"Update the 'Learn More' section (around line 242) in README.md to add DEVELOPMENT.md as the first link under a new 'Scaffold Documentation' subsection. Also add links to report issues (github.com/hypercerts-org/hypercerts-scaffold-atproto/issues) and mention @kzoeps as maintainer. Reorganize external docs links into a separate subsection. Depends on hypercerts-p9n.1 because DEVELOPMENT.md must exist to link to it.","status":"closed","priority":3,"issue_type":"task","assignee":"kzoeps","owner":"kzoepa@gmail.com","created_at":"2026-02-13T11:18:53.526270655+06:00","created_by":"kzoeps","updated_at":"2026-02-13T11:26:50.075541431+06:00","closed_at":"2026-02-13T11:26:50.075541431+06:00","close_reason":"Completed: 9aee7d0 - Reorganized Learn More section with DEVELOPMENT.md, external docs, and issue reporting links","dependencies":[{"issue_id":"hypercerts-p9n.6","depends_on_id":"hypercerts-p9n","type":"parent-child","created_at":"2026-02-13T11:18:53.528019597+06:00","created_by":"kzoeps"},{"issue_id":"hypercerts-p9n.6","depends_on_id":"hypercerts-p9n.1","type":"blocks","created_at":"2026-02-13T11:19:06.902665893+06:00","created_by":"kzoeps"}]}
{"id":"hypercerts-p9n.7","title":"Review and update code examples in README","description":"Review all code snippets throughout README.md for accuracy with current codebase: (1) Check Authentication section code example (lines 170-187), (2) Check Repository Context section (lines 193-210), (3) Verify all imports are correct, (4) Verify function signatures match current SDK version, (5) Add helpful comments where appropriate, (6) Ensure examples follow best practices. This is a review/polish task to ensure documentation matches implementation.","status":"closed","priority":3,"issue_type":"task","assignee":"kzoeps","owner":"kzoepa@gmail.com","created_at":"2026-02-13T11:19:00.53603122+06:00","created_by":"kzoeps","updated_at":"2026-02-13T11:28:18.636827322+06:00","closed_at":"2026-02-13T11:28:18.636827322+06:00","close_reason":"Completed: 91d11f0 - Reviewed and improved all code examples, added simpler alternatives, fixed authentication flow description","dependencies":[{"issue_id":"hypercerts-p9n.7","depends_on_id":"hypercerts-p9n","type":"parent-child","created_at":"2026-02-13T11:19:00.537513614+06:00","created_by":"kzoeps"}]}
{"id":"hypercerts-qc3","title":"Epic: PDS Sidecar Auth Service","description":"## Goal\nBuild a standalone Express.js auth service that runs alongside the stock `@atproto/pds` package to provide email-first passwordless login via OTP codes. This lives in `packages/pds-sidecar/` within the hypercerts-scaffold repo (same PR as the scaffold UI changes).\n\n## Context\nATProto's PDS has a built-in OAuth authorization server with a password-based sign-in form. We want to replace this with email + OTP for the Certified ecosystem (Ma Earth, GainForest, etc.). The PDS is ~80% ready for email OTP — the `emailOtp` field exists in the sign-in schema, `SecondAuthenticationFactorRequiredError` is implemented, email token infrastructure is production-ready, and password is already optional at the AccountManager level. The blocker is a hard `throw new Error('Email OTP is not supported')` in `OAuthStore.authenticateAccount()`.\n\nRather than forking the PDS, we build a **sidecar auth service** that:\n1. Overrides the PDS's OAuth authorization server metadata (`/.well-known/oauth-authorization-server`) to redirect the `authorization_endpoint` to itself\n2. Serves its own email input + OTP verification pages\n3. After OTP verification, calls into the PDS's internal `OAuthProvider` APIs to create accounts (if new) and issue OAuth authorization codes\n4. Redirects the user back to the client app with a standard OAuth code\n\nFrom the client app's perspective, this is a normal OAuth flow. The client doesn't know the sidecar exists.\n\n## Location\nAll sidecar code lives under `packages/pds-sidecar/` in the hypercerts-scaffold repo. This is a monorepo with three sub-packages:\n- `packages/pds-sidecar/packages/shared/` — DB, OTP service, rate limiter, HMAC signer, mailer\n- `packages/pds-sidecar/packages/auth-service/` — Express auth service\n- `packages/pds-sidecar/packages/pds-core/` — PDS wrapper\n\n## Architecture\n```\nClient App (scaffold)\n  │\n  │ 1. PAR request\n  │ 8. Token exchange (stock ATProto)\n  ▼\nPDS Core (stock @atproto/pds, unmodified npm package)\n  │  AS metadata overridden:\n  │  authorization_endpoint → auth.pds.certs.network\n  │\n  │ 2. Redirect to sidecar    7. Auth code issued via signed callback\n  ▼                            ▲\nSidecar Auth Service (Express)\n  GET  /oauth/authorize     ← email input form\n  POST /auth/send-code      ← generate OTP, send email\n  POST /auth/verify-code    ← validate OTP\n  GET  /auth/consent        ← consent screen\n  │\n  │ 3-5. Email 6-digit OTP code\n  ▼\nUser's inbox\n```\n\n## Key Design Decisions\n1. **Wrap, don't fork.** `@atproto/pds` is an npm dependency, not modified source.\n2. **Signed callback.** HMAC-SHA256 between sidecar and PDS to prevent account takeover.\n3. **Unified sign-in/sign-up.** New emails get an account auto-created; existing emails get authenticated.\n4. **`login_hint` passthrough.** Client passes email as `login_hint` → sidecar sends OTP immediately.\n5. **Random handles.** New accounts get random handles to avoid leaking emails.\n6. **8-digit OTP codes.** Better brute-force resistance.\n\n## Security Requirements\n- HMAC-SHA256 signed callback between sidecar and PDS\n- OTP codes: 8 digits, SHA-256 hashed before storage, single-use, 15-min expiry, max 5 attempts\n- Rate limiting: per-email (3/15min, 5/hr), per-IP (10/15min)\n- Anti-enumeration: show OTP form regardless of whether email exists\n- CSRF protection: double-submit cookie with timing-safe comparison\n- Security headers: HSTS, CSP, X-Frame-Options, X-Content-Type-Options\n\n## Success Criteria\n- Sidecar starts alongside stock PDS, overrides AS metadata\n- Email OTP flow works end-to-end\n- New accounts auto-created with random handles\n- Callback between sidecar and PDS is HMAC-signed\n- Rate limiting and anti-enumeration in place","status":"open","priority":1,"issue_type":"epic","assignee":"sharfy-test.climateai.org","owner":"sharfy-test.climateai.org","created_at":"2026-02-17T18:12:07.512977+08:00","created_by":"sharfy-test.climateai.org","updated_at":"2026-02-17T18:33:36.627632+08:00","labels":["scope:medium"]}
{"id":"hypercerts-qc3.1","title":"Initialize sidecar repo with monorepo structure","description":"## Files\n- packages/pds-sidecar/package.json (create)\n- packages/pds-sidecar/tsconfig.json (create)\n- packages/pds-sidecar/packages/shared/package.json (create)\n- packages/pds-sidecar/packages/shared/src/index.ts (create)\n- packages/pds-sidecar/packages/shared/src/db.ts (create)\n- packages/pds-sidecar/packages/shared/src/types.ts (create)\n- packages/pds-sidecar/packages/shared/src/logger.ts (create)\n- packages/pds-sidecar/packages/auth-service/package.json (create)\n- packages/pds-sidecar/packages/auth-service/src/index.ts (create)\n- packages/pds-sidecar/packages/pds-core/package.json (create)\n- packages/pds-sidecar/packages/pds-core/src/index.ts (create)\n- packages/pds-sidecar/.gitignore (create)\n- packages/pds-sidecar/README.md (create)\n\n## What to do\nCreate the PDS sidecar monorepo structure under `packages/pds-sidecar/` in the hypercerts-scaffold repo. This directory contains three sub-packages using npm workspaces.\n\n### Root `packages/pds-sidecar/package.json`\n- Name: `@certified/pds-sidecar`\n- Private: true\n- Workspaces: `['packages/*']`\n- Scripts: `dev`, `build`, `test`, `lint`\n- Engine: Node.js \u003e= 20\n\n### `packages/pds-sidecar/packages/shared`\nShared utilities used by both auth-service and pds-core:\n- **`db.ts`**: Initialize better-sqlite3 database. Export a `createDatabase(path: string)` function that creates the SQLite file and returns a Database instance. Create tables on init:\n  - `accounts`: `id INTEGER PRIMARY KEY, email TEXT UNIQUE NOT NULL, did TEXT UNIQUE, handle TEXT, created_at TEXT DEFAULT CURRENT_TIMESTAMP`\n  - `otp_tokens`: `id INTEGER PRIMARY KEY, email TEXT NOT NULL, token_hash TEXT NOT NULL, attempts INTEGER DEFAULT 0, max_attempts INTEGER DEFAULT 5, expires_at TEXT NOT NULL, used INTEGER DEFAULT 0, created_at TEXT DEFAULT CURRENT_TIMESTAMP`\n  - `rate_limits`: `id INTEGER PRIMARY KEY, key TEXT NOT NULL, action TEXT NOT NULL, count INTEGER DEFAULT 1, window_start TEXT NOT NULL`\n- **`types.ts`**: Shared TypeScript types (`Account`, `OTPToken`, `RateLimitEntry`)\n- **`logger.ts`**: Pino logger instance with pretty-print in dev\n\n### `packages/pds-sidecar/packages/auth-service`\nThe Express auth service (skeleton only in this task):\n- `src/index.ts`: Create Express app, add JSON body parser, add a health check route `GET /health` that returns `{ status: 'ok' }`. Listen on `process.env.AUTH_PORT || 3001`.\n- Dependencies: express, cors, cookie-parser\n\n### `packages/pds-sidecar/packages/pds-core`\nThe PDS wrapper (skeleton only in this task):\n- `src/index.ts`: Import `@atproto/pds` and create a minimal PDS startup script. For now, just log 'PDS core starting...' and export a placeholder `startPDS()` function.\n- Dependencies: @atproto/pds\n\n### TypeScript config\n- Root `tsconfig.json` with project references\n- Each package has its own `tsconfig.json` extending root\n- Target: ES2022, module: Node16, strict: true\n\n### IMPORTANT: Do not modify the root scaffold package.json\nThe sidecar has its own independent package.json and node_modules. Run `npm install` from within `packages/pds-sidecar/`, not from the repo root.\n\n## Don't\n- Don't modify any files outside `packages/pds-sidecar/`\n- Don't implement any auth logic (that's later tasks)\n- Don't implement the OAuth metadata override (that's later)\n- Don't set up Docker yet (that's the deployment epic)\n- Don't install nodemailer yet (that's the OTP task)\n- Don't modify the root package.json or any scaffold files","acceptance_criteria":"1. `npm install` succeeds at the root\n2. `npm run build` compiles all three packages without errors\n3. Running `packages/auth-service` starts Express on port 3001 and `GET /health` returns `{ status: 'ok' }`\n4. SQLite database is created with the three tables when `createDatabase()` is called\n5. All TypeScript compiles with strict mode enabled\n6. `.gitignore` excludes node_modules, dist, *.sqlite","status":"closed","priority":1,"issue_type":"task","assignee":"sharfy-test.climateai.org","owner":"sharfy-test.climateai.org","estimated_minutes":45,"created_at":"2026-02-17T18:13:53.671557+08:00","created_by":"sharfy-test.climateai.org","updated_at":"2026-02-17T18:38:19.085359+08:00","closed_at":"2026-02-17T18:38:19.085359+08:00","close_reason":"4a06158 Initialize pds-sidecar monorepo with shared, auth-service, pds-core packages","labels":["scope:small"],"dependencies":[{"issue_id":"hypercerts-qc3.1","depends_on_id":"hypercerts-qc3","type":"parent-child","created_at":"2026-02-17T18:13:53.672463+08:00","created_by":"sharfy-test.climateai.org"}]}
{"id":"hypercerts-qc3.2","title":"Implement OTP generation, hashing, and verification service","description":"## Files\n- packages/shared/src/otp-service.ts (create)\n- packages/shared/src/otp-service.test.ts (create)\n\n## What to do\nImplement the OTP token service in the shared package. This handles generating, storing (hashed), and verifying one-time passcodes.\n\n### `otp-service.ts`\n\nExport a class `OTPService` that takes a Database instance (from `db.ts`) in its constructor.\n\n**Methods:**\n\n#### `async generateOTP(email: string): Promise\u003c{ code: string; expiresAt: Date }\u003e`\n1. Generate an 8-digit random numeric code using `crypto.randomInt(10000000, 99999999)`\n2. Hash the code with SHA-256: `crypto.createHash('sha256').update(code).digest('hex')`\n3. Calculate expiry: `new Date(Date.now() + 15 * 60 * 1000)` (15 minutes)\n4. Mark any existing unused tokens for this email as used (prevent token accumulation)\n5. Insert into `otp_tokens` table: `{ email, token_hash, attempts: 0, max_attempts: 5, expires_at, used: 0 }`\n6. Return `{ code, expiresAt }` (the plaintext code — caller sends it via email)\n\n#### `async verifyOTP(email: string, code: string): Promise\u003c{ valid: boolean; error?: string }\u003e`\n1. Hash the provided code with SHA-256\n2. Find the most recent unused, non-expired token for this email: `SELECT * FROM otp_tokens WHERE email = ? AND used = 0 AND expires_at \u003e datetime('now') ORDER BY created_at DESC LIMIT 1`\n3. If no token found: return `{ valid: false, error: 'No valid code found. Please request a new one.' }`\n4. Increment the `attempts` counter on the token\n5. If `attempts \u003e= max_attempts`: mark token as used, return `{ valid: false, error: 'Too many attempts. Please request a new code.' }`\n6. Compare hashes using `crypto.timingSafeEqual(Buffer.from(storedHash, 'hex'), Buffer.from(providedHash, 'hex'))`\n7. If match: mark token as used, return `{ valid: true }`\n8. If no match: return `{ valid: false, error: 'Invalid code. Please try again.' }`\n\n#### `async cleanupExpired(): Promise\u003cnumber\u003e`\nDelete all tokens where `expires_at \u003c datetime('now')` or `used = 1`. Return count of deleted rows. This should be called periodically (e.g., every 5 minutes via setInterval).\n\n### Test file: `otp-service.test.ts`\nWrite vitest tests covering:\n1. `generateOTP` returns an 8-digit numeric string\n2. `verifyOTP` succeeds with correct code\n3. `verifyOTP` fails with wrong code\n4. `verifyOTP` fails after code expires (mock time or use short expiry)\n5. `verifyOTP` fails after max attempts exceeded\n6. `verifyOTP` fails when no token exists\n7. Generating a new OTP invalidates the previous one for the same email\n8. `cleanupExpired` removes old tokens\n9. Timing-safe comparison is used (verify by checking the code path, not timing)\n\nUse an in-memory SQLite database for tests (`createDatabase(':memory:')`).\n\n## Don't\n- Don't implement rate limiting here (that's a separate service)\n- Don't implement email sending here (that's a separate task)\n- Don't store plaintext codes in the database\n- Don't use Math.random() — use crypto.randomInt() for cryptographic randomness","acceptance_criteria":"1. `npm test` passes all 9+ test cases\n2. OTP codes are exactly 8 digits (numeric only)\n3. Codes are stored as SHA-256 hashes, never plaintext\n4. Verification uses `crypto.timingSafeEqual`\n5. Tokens are single-use (marked used after successful verification)\n6. Tokens expire after 15 minutes\n7. Max 5 verification attempts per token\n8. Generating a new OTP for the same email invalidates previous unused tokens","status":"closed","priority":1,"issue_type":"task","assignee":"sharfy-test.climateai.org","owner":"sharfy-test.climateai.org","estimated_minutes":45,"created_at":"2026-02-17T18:14:15.505739+08:00","created_by":"sharfy-test.climateai.org","updated_at":"2026-02-17T18:40:13.952341+08:00","closed_at":"2026-02-17T18:40:13.952341+08:00","close_reason":"00d3e19 Implement OTP generation, hashing, and verification service","labels":["scope:small"],"dependencies":[{"issue_id":"hypercerts-qc3.2","depends_on_id":"hypercerts-qc3","type":"parent-child","created_at":"2026-02-17T18:14:15.506563+08:00","created_by":"sharfy-test.climateai.org"},{"issue_id":"hypercerts-qc3.2","depends_on_id":"hypercerts-qc3.1","type":"blocks","created_at":"2026-02-17T18:14:15.507565+08:00","created_by":"sharfy-test.climateai.org"}]}
{"id":"hypercerts-qc3.3","title":"Implement rate limiting service","description":"## Files\n- packages/shared/src/rate-limiter.ts (create)\n- packages/shared/src/rate-limiter.test.ts (create)\n\n## What to do\nImplement a rate limiting service that enforces per-email and per-IP limits for OTP requests. Uses the `rate_limits` table from the shared database.\n\n### `rate-limiter.ts`\n\nExport a class `RateLimiter` that takes a Database instance in its constructor.\n\n**Methods:**\n\n#### `async checkLimit(key: string, action: string, maxCount: number, windowMinutes: number): Promise\u003c{ allowed: boolean; retryAfterSeconds?: number }\u003e`\n1. Calculate window start: `new Date(Date.now() - windowMinutes * 60 * 1000)`\n2. Query: `SELECT SUM(count) as total FROM rate_limits WHERE key = ? AND action = ? AND window_start \u003e ?`\n3. If `total \u003e= maxCount`: return `{ allowed: false, retryAfterSeconds: \u003cseconds until oldest entry in window expires\u003e }`\n4. Otherwise: insert or update the rate limit entry for the current minute window, return `{ allowed: true }`\n\n#### `async recordAction(key: string, action: string): Promise\u003cvoid\u003e`\nInsert a new rate limit entry or increment the count for the current minute window.\n\n#### `async cleanupOld(): Promise\u003cnumber\u003e`\nDelete entries older than 1 hour. Return count deleted.\n\n### Predefined limit configurations (export as constants):\n\n```typescript\nexport const RATE_LIMITS = {\n  OTP_PER_EMAIL: { action: 'otp_send', maxCount: 5, windowMinutes: 60 },\n  OTP_PER_EMAIL_BURST: { action: 'otp_send', maxCount: 3, windowMinutes: 15 },\n  OTP_PER_IP: { action: 'otp_send_ip', maxCount: 10, windowMinutes: 15 },\n  VERIFY_PER_IP: { action: 'otp_verify_ip', maxCount: 20, windowMinutes: 15 },\n} as const;\n```\n\n### Express middleware factory (export):\n```typescript\nexport function rateLimitMiddleware(\n  rateLimiter: RateLimiter,\n  keyExtractor: (req: Request) =\u003e string,\n  config: { action: string; maxCount: number; windowMinutes: number }\n): RequestHandler\n```\n- Extract key from request using `keyExtractor`\n- Call `checkLimit`\n- If not allowed: respond with 429 and `Retry-After` header\n- If allowed: call `recordAction` and `next()`\n\n### Tests\n1. Allows requests under the limit\n2. Blocks requests over the limit\n3. Returns correct `retryAfterSeconds`\n4. Different keys are tracked independently\n5. Different actions are tracked independently\n6. Cleanup removes old entries\n7. Middleware returns 429 when rate limited\n\nUse in-memory SQLite for tests.\n\n## Don't\n- Don't use in-memory-only rate limiting (must survive process restart via SQLite)\n- Don't implement Redis-based rate limiting (SQLite is sufficient for single-server)\n- Don't add Express as a dependency to the shared package — the middleware factory should accept generic types or be in a separate file that auth-service imports","acceptance_criteria":"1. `npm test` passes all 7+ test cases\n2. Rate limiter correctly blocks after maxCount requests within windowMinutes\n3. Rate limiter allows requests after the window expires\n4. Different keys and actions are tracked independently\n5. Middleware returns HTTP 429 with Retry-After header when rate limited\n6. Cleanup removes entries older than 1 hour","status":"closed","priority":1,"issue_type":"task","assignee":"sharfy-test.climateai.org","owner":"sharfy-test.climateai.org","estimated_minutes":40,"created_at":"2026-02-17T18:14:34.643111+08:00","created_by":"sharfy-test.climateai.org","updated_at":"2026-02-17T18:40:20.358772+08:00","closed_at":"2026-02-17T18:40:20.358772+08:00","close_reason":"614da36 Implement rate limiting service","labels":["scope:small"],"dependencies":[{"issue_id":"hypercerts-qc3.3","depends_on_id":"hypercerts-qc3","type":"parent-child","created_at":"2026-02-17T18:14:34.644336+08:00","created_by":"sharfy-test.climateai.org"},{"issue_id":"hypercerts-qc3.3","depends_on_id":"hypercerts-qc3.1","type":"blocks","created_at":"2026-02-17T18:14:34.645479+08:00","created_by":"sharfy-test.climateai.org"}]}
{"id":"hypercerts-qc3.4","title":"Implement HMAC-signed callback between sidecar and PDS","description":"## Files\n- packages/shared/src/callback-signer.ts (create)\n- packages/shared/src/callback-signer.test.ts (create)\n\n## What to do\nImplement the cryptographic signing and verification for the callback between the sidecar auth service and the PDS. This is the **critical security fix** over the magic-pds reference implementation, which uses unsigned callbacks (enabling account takeover).\n\n### Background\nAfter the sidecar verifies a user's OTP, it needs to tell the PDS 'this user is authenticated, issue an auth code.' In magic-pds, this is done via a plain redirect with query parameters (`?email=user@example.com\u0026approved=1`). Anyone who can reach the PDS's callback endpoint can forge this. Our implementation signs the callback with HMAC-SHA256 using a shared secret.\n\n### `callback-signer.ts`\n\nExport a class `CallbackSigner` that takes a `secret: string` in its constructor.\n\n**Methods:**\n\n#### `sign(params: CallbackParams): string`\n```typescript\ninterface CallbackParams {\n  requestUri: string;   // The PAR request URI (urn:ietf:params:oauth:request_uri:...)\n  email: string;        // The authenticated user's email\n  approved: boolean;    // Whether the user approved the request\n  newAccount: boolean;  // Whether this is a new account creation\n  timestamp: number;    // Unix timestamp in seconds (Date.now() / 1000)\n}\n```\n1. Serialize params deterministically: `${requestUri}|${email}|${approved}|${newAccount}|${timestamp}`\n2. Compute HMAC-SHA256: `crypto.createHmac('sha256', this.secret).update(serialized).digest('hex')`\n3. Return the hex signature\n\n#### `verify(params: CallbackParams, signature: string, maxAgeSeconds: number = 300): { valid: boolean; error?: string }`\n1. Check timestamp is within `maxAgeSeconds` of current time (prevents replay attacks). Return `{ valid: false, error: 'Callback expired' }` if too old.\n2. Recompute the expected signature using `sign(params)`\n3. Compare using `crypto.timingSafeEqual(Buffer.from(signature, 'hex'), Buffer.from(expected, 'hex'))`\n4. Return `{ valid: true }` or `{ valid: false, error: 'Invalid signature' }`\n\n#### `buildCallbackUrl(baseUrl: string, params: CallbackParams): string`\nBuild the full callback URL with all params as query parameters plus the signature:\n```\n{baseUrl}/oauth/magic-callback?request_uri={requestUri}\u0026email={email}\u0026approved={approved}\u0026new_account={newAccount}\u0026timestamp={timestamp}\u0026sig={signature}\n```\n\n#### `static parseCallbackUrl(url: URL): { params: CallbackParams; signature: string }`\nParse query parameters back into `CallbackParams` and extract the signature.\n\n### Tests\n1. `sign` produces a consistent signature for the same inputs\n2. `sign` produces different signatures for different inputs\n3. `verify` succeeds with a valid signature\n4. `verify` fails with a tampered email\n5. `verify` fails with a tampered approved flag\n6. `verify` fails with a wrong secret\n7. `verify` fails when timestamp is too old (expired)\n8. `verify` fails when timestamp is in the future (clock skew \u003e maxAge)\n9. `buildCallbackUrl` produces a valid URL with all params\n10. `parseCallbackUrl` round-trips with `buildCallbackUrl`\n11. Timing-safe comparison is used\n\n## Don't\n- Don't use JWT for this (HMAC is simpler and sufficient for server-to-server within the same deployment)\n- Don't use asymmetric keys (shared secret is fine since both services are co-deployed)\n- Don't hardcode the secret — it's passed to the constructor","acceptance_criteria":"1. `npm test` passes all 11 test cases\n2. Signatures are HMAC-SHA256 hex strings\n3. Verification uses `crypto.timingSafeEqual`\n4. Expired callbacks (\u003e5 min by default) are rejected\n5. Tampered parameters are rejected\n6. `buildCallbackUrl` and `parseCallbackUrl` round-trip correctly","status":"closed","priority":1,"issue_type":"task","assignee":"sharfy-test.climateai.org","owner":"sharfy-test.climateai.org","estimated_minutes":40,"created_at":"2026-02-17T18:14:57.2573+08:00","created_by":"sharfy-test.climateai.org","updated_at":"2026-02-17T18:39:54.935494+08:00","closed_at":"2026-02-17T18:39:54.935494+08:00","close_reason":"ca63038 Implement HMAC-signed callback signer with 11 tests","labels":["scope:small"],"dependencies":[{"issue_id":"hypercerts-qc3.4","depends_on_id":"hypercerts-qc3","type":"parent-child","created_at":"2026-02-17T18:14:57.258125+08:00","created_by":"sharfy-test.climateai.org"},{"issue_id":"hypercerts-qc3.4","depends_on_id":"hypercerts-qc3.1","type":"blocks","created_at":"2026-02-17T18:14:57.259258+08:00","created_by":"sharfy-test.climateai.org"}]}
{"id":"hypercerts-qc3.5","title":"Implement OTP email sending service","description":"## Files\n- packages/shared/src/mailer.ts (create)\n- packages/shared/src/mailer.test.ts (create)\n\n## What to do\nImplement the email sending service for OTP codes. Uses nodemailer with SMTP transport.\n\n### `mailer.ts`\n\nExport a class `Mailer` with constructor:\n```typescript\nconstructor(config: {\n  host: string;\n  port: number;\n  secure: boolean;\n  auth: { user: string; pass: string };\n  from: string;  // e.g., 'Hypercerts \u003cnoreply@certified.app\u003e'\n})\n```\n\n**Methods:**\n\n#### `async sendOTP(to: string, code: string, options?: { appName?: string }): Promise\u003cvoid\u003e`\nSend an email with the OTP code. The email should be:\n- **Subject:** `Your sign-in code: ${code}` (include code in subject for quick access on mobile)\n- **From:** The configured `from` address\n- **HTML body:** Clean, minimal HTML email:\n  - App name heading (defaults to 'Hypercerts Scaffold')\n  - 'Your sign-in code is:' text\n  - The 8-digit code displayed large and monospaced (easy to read/copy)\n  - 'This code expires in 15 minutes.' subtext\n  - 'If you didn't request this code, you can safely ignore this email.' footer\n- **Text body:** Plain text fallback with the same content\n\n#### `async verifyConnection(): Promise\u003cboolean\u003e`\nCall `transporter.verify()` to check SMTP connectivity. Return true/false. Log errors but don't throw.\n\n### Test file\n- Mock nodemailer's `createTransport` to capture sent emails\n- Test that `sendOTP` calls `sendMail` with correct to, from, subject, html, text\n- Test that the code appears in both HTML and text bodies\n- Test that `verifyConnection` returns false when SMTP is unreachable\n- Test custom `appName` appears in the email\n\n## Don't\n- Don't implement custom email templates per OAuth client (that's a future enhancement)\n- Don't implement email template fetching from URLs (SSRF risk — magic-pds had this issue)\n- Don't send emails in tests — mock the transport","acceptance_criteria":"1. `npm test` passes all test cases\n2. `sendOTP` sends an email with the code in subject, HTML body, and text body\n3. Email has both HTML and plain text versions\n4. Code is displayed prominently in the HTML (large, monospaced)\n5. `verifyConnection` returns true/false without throwing\n6. No real emails are sent during tests (transport is mocked)","status":"closed","priority":1,"issue_type":"task","assignee":"sharfy-test.climateai.org","owner":"sharfy-test.climateai.org","estimated_minutes":30,"created_at":"2026-02-17T18:15:14.469648+08:00","created_by":"sharfy-test.climateai.org","updated_at":"2026-02-17T18:40:31.949481+08:00","closed_at":"2026-02-17T18:40:31.949481+08:00","close_reason":"d5ae3b7 Implement OTP email sending service","labels":["scope:small"],"dependencies":[{"issue_id":"hypercerts-qc3.5","depends_on_id":"hypercerts-qc3","type":"parent-child","created_at":"2026-02-17T18:15:14.470511+08:00","created_by":"sharfy-test.climateai.org"},{"issue_id":"hypercerts-qc3.5","depends_on_id":"hypercerts-qc3.1","type":"blocks","created_at":"2026-02-17T18:15:14.471624+08:00","created_by":"sharfy-test.climateai.org"}]}
{"id":"hypercerts-qc3.6","title":"Implement auth service routes: send-code, verify-code, authorize","description":"## Files\n- packages/auth-service/src/routes/authorize.ts (create)\n- packages/auth-service/src/routes/send-code.ts (create)\n- packages/auth-service/src/routes/verify-code.ts (create)\n- packages/auth-service/src/middleware/security.ts (create)\n- packages/auth-service/src/middleware/csrf.ts (create)\n- packages/auth-service/src/index.ts (modify)\n\n## What to do\nImplement the three core auth service routes that handle the email OTP flow. These are the routes that the user's browser interacts with after being redirected from the PDS.\n\n### Flow overview\n1. PDS redirects user to sidecar: `GET /oauth/authorize?request_uri=urn:...\u0026client_id=...\u0026login_hint=user@example.com`\n2. Sidecar shows email form (or auto-sends OTP if `login_hint` is present)\n3. User submits email → `POST /auth/send-code` → sidecar sends OTP email\n4. User enters code → `POST /auth/verify-code` → sidecar verifies OTP\n5. On success: sidecar builds HMAC-signed callback URL and redirects to PDS\n\n### `middleware/security.ts`\nAdd security headers to all responses:\n- `Strict-Transport-Security: max-age=31536000; includeSubDomains`\n- `X-Content-Type-Options: nosniff`\n- `X-Frame-Options: DENY`\n- `Content-Security-Policy: default-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:`\n\n### `middleware/csrf.ts`\nImplement double-submit cookie CSRF protection:\n- On GET requests: generate a random CSRF token, set it as a cookie (`csrf-token`, HttpOnly=false so JS can read it, Secure in production, SameSite=Lax`)\n- On POST requests: compare the `csrf-token` cookie with the `x-csrf-token` header using `crypto.timingSafeEqual`\n- Reject with 403 if they don't match\n\n### `routes/authorize.ts` — `GET /oauth/authorize`\nThis is the entry point — the PDS redirects here after PAR.\n\n**Query params:** `request_uri`, `client_id`, `login_hint` (optional)\n\n**Logic:**\n1. Validate `request_uri` is present (required)\n2. Store `request_uri` and `client_id` in a session cookie (encrypted or signed) so they survive the send-code/verify-code round-trip\n3. If `login_hint` is present and looks like an email (contains `@`):\n   - Auto-trigger OTP send (call OTPService.generateOTP + Mailer.sendOTP)\n   - Render the OTP verification page directly (skip email input)\n4. If no `login_hint` or it's not an email:\n   - Render the email input page\n\n**Pages:** Server-rendered HTML (use a simple template function, no React needed):\n- Email input page: form with email input, 'Continue' button\n- OTP verification page: form with 8-digit code input, 'Verify' button, 'Resend code' link, masked email display (e.g., 'u***@example.com')\n\n### `routes/send-code.ts` — `POST /auth/send-code`\n**Body:** `{ email: string }`\n\n**Logic:**\n1. Validate CSRF token\n2. Check rate limits (per-email burst + hourly, per-IP)\n3. Normalize email (lowercase, trim)\n4. Generate OTP via OTPService\n5. Send OTP via Mailer\n6. **Anti-enumeration:** Always respond with success, even if the email doesn't exist in the system. The OTP is generated regardless — if the email is new, the account will be created after verification.\n7. Store email in session cookie for the verify step\n8. Respond with redirect to OTP verification page (or JSON `{ success: true }` if called via fetch)\n\n### `routes/verify-code.ts` — `POST /auth/verify-code`\n**Body:** `{ code: string }`\n\n**Logic:**\n1. Validate CSRF token\n2. Check rate limits (per-IP verify limit)\n3. Retrieve email from session cookie\n4. Verify OTP via OTPService\n5. If invalid: re-render OTP page with error message\n6. If valid:\n   a. Check if email exists in the accounts table\n   b. If new email: set `newAccount = true`\n   c. Build HMAC-signed callback URL using CallbackSigner\n   d. Redirect to PDS callback: `{pdsUrl}/oauth/magic-callback?request_uri=...\u0026email=...\u0026approved=1\u0026new_account=...\u0026timestamp=...\u0026sig=...`\n\n### Session cookies\nUse a signed cookie (using the HMAC secret) to store the OAuth flow state across requests:\n```typescript\ninterface AuthFlowSession {\n  requestUri: string;\n  clientId: string;\n  email?: string;\n}\n```\nSign with HMAC-SHA256 using the same shared secret. Set HttpOnly, Secure (in production), SameSite=Lax, Max-Age=600 (10 minutes).\n\n## Don't\n- Don't use React or any frontend framework for the HTML pages — use template literals\n- Don't implement the PDS-side callback handler (that's a separate task in pds-core)\n- Don't implement consent screens (that's a future task)\n- Don't fetch OAuth client metadata for branding (future enhancement)","acceptance_criteria":"1. GET /oauth/authorize with `request_uri` renders an email input page\n2. GET /oauth/authorize with `request_uri` and `login_hint=user@example.com` auto-sends OTP and renders OTP verification page\n3. POST /auth/send-code sends an OTP email and redirects to verification page\n4. POST /auth/send-code returns success even for unknown emails (anti-enumeration)\n5. POST /auth/verify-code with correct code redirects to PDS callback with HMAC signature\n6. POST /auth/verify-code with wrong code re-renders OTP page with error\n7. CSRF protection rejects POST requests without valid token\n8. Rate limiting returns 429 when limits exceeded\n9. Security headers are present on all responses\n10. Session state survives across the authorize → send-code → verify-code flow","status":"open","priority":1,"issue_type":"task","owner":"sharfy-test.climateai.org","estimated_minutes":60,"created_at":"2026-02-17T18:15:49.998905+08:00","created_by":"sharfy-test.climateai.org","updated_at":"2026-02-17T18:15:49.998905+08:00","labels":["scope:medium"],"dependencies":[{"issue_id":"hypercerts-qc3.6","depends_on_id":"hypercerts-qc3","type":"parent-child","created_at":"2026-02-17T18:15:50.001457+08:00","created_by":"sharfy-test.climateai.org"},{"issue_id":"hypercerts-qc3.6","depends_on_id":"hypercerts-qc3.2","type":"blocks","created_at":"2026-02-17T18:15:50.003149+08:00","created_by":"sharfy-test.climateai.org"},{"issue_id":"hypercerts-qc3.6","depends_on_id":"hypercerts-qc3.3","type":"blocks","created_at":"2026-02-17T18:15:50.00393+08:00","created_by":"sharfy-test.climateai.org"},{"issue_id":"hypercerts-qc3.6","depends_on_id":"hypercerts-qc3.4","type":"blocks","created_at":"2026-02-17T18:15:50.004741+08:00","created_by":"sharfy-test.climateai.org"},{"issue_id":"hypercerts-qc3.6","depends_on_id":"hypercerts-qc3.5","type":"blocks","created_at":"2026-02-17T18:15:50.005499+08:00","created_by":"sharfy-test.climateai.org"}]}
{"id":"hypercerts-qc3.7","title":"Implement PDS core wrapper with OAuth metadata override and magic-callback endpoint","description":"## Files\n- packages/pds-core/src/index.ts (modify)\n- packages/pds-core/src/metadata-override.ts (create)\n- packages/pds-core/src/magic-callback.ts (create)\n- packages/pds-core/src/account-creator.ts (create)\n\n## What to do\nImplement the PDS wrapper that starts a stock `@atproto/pds` instance with two additions: (1) an Express middleware that overrides the OAuth authorization server metadata to point to the sidecar, and (2) a `/oauth/magic-callback` endpoint that accepts HMAC-signed callbacks from the sidecar and issues OAuth authorization codes.\n\n### Background\nThe stock PDS serves `GET /.well-known/oauth-authorization-server` which returns metadata including `authorization_endpoint` pointing to itself. We intercept this and rewrite `authorization_endpoint` to point to the sidecar auth service. All other OAuth endpoints (PAR, token, JWKS) remain on the PDS.\n\nAfter the sidecar verifies the user's OTP, it redirects the user's browser to `/oauth/magic-callback` on the PDS with HMAC-signed parameters. The PDS verifies the signature, then uses its internal `OAuthProvider` to issue an authorization code and redirect the user back to the client app.\n\n### `metadata-override.ts`\nExport a function `createMetadataOverride(authServiceUrl: string): RequestHandler` that:\n1. Intercepts `GET /.well-known/oauth-authorization-server`\n2. Calls `next()` to let the stock PDS generate the response\n3. Captures the response body (use response interception — override `res.json` or use a response-capture middleware pattern)\n4. Replaces `authorization_endpoint` with `${authServiceUrl}/oauth/authorize`\n5. Sends the modified response\n\n**Important:** This middleware must be mounted BEFORE the PDS middleware in the Express stack so it can intercept the response.\n\n### `magic-callback.ts`\nExport a function `createMagicCallback(pds: PDS, callbackSigner: CallbackSigner): RequestHandler` that handles `GET /oauth/magic-callback`:\n\n1. Parse query parameters using `CallbackSigner.parseCallbackUrl`\n2. Verify the HMAC signature using `callbackSigner.verify()`\n3. If invalid: return 403 with error\n4. If `approved !== true`: return 403 'Request not approved'\n5. If `newAccount === true`:\n   - Call `accountCreator.createAccount(email)` to create a new ATProto account\n6. Look up the user's DID from the email (query the sidecar's accounts table or the PDS's internal account manager)\n7. Use the PDS's internal `OAuthProvider` to:\n   a. Load the pending PAR request using `requestUri`\n   b. Create or load a device session for the user\n   c. Mark the request as authorized for the user's DID\n   d. Generate an authorization code\n   e. Build the redirect URL back to the client app\n8. Redirect the user's browser to the client app with the authorization code\n\n**Accessing PDS internals:** The PDS instance exposes `pds.ctx.oauthProvider` (accessed via `as any` cast since it's not part of the public API). Key internal APIs:\n- `pds.ctx.oauthProvider.deviceManager` — manage device sessions\n- `pds.ctx.oauthProvider.requestManager` — load PAR requests\n- `pds.ctx.accountManager` — look up accounts by email\n\n**Note:** These are internal APIs that may change between `@atproto/pds` versions. Document each access point with a comment noting the PDS version it was tested against.\n\n### `account-creator.ts`\nExport a class `AccountCreator` that creates new ATProto accounts on the PDS:\n\n```typescript\nasync createAccount(email: string): Promise\u003c{ did: string; handle: string }\u003e\n```\n\n1. Generate a random handle: `${randomBase36(6)}.${pdsDomain}` (e.g., `a3x9kf.pds.certs.network`)\n2. Generate a random throwaway password: `crypto.randomBytes(64).toString('hex')`\n3. Call the PDS's internal account creation (via `pds.ctx.accountManager` or the XRPC endpoint `com.atproto.server.createAccount`)\n4. Store the email→DID mapping in the sidecar's accounts table\n5. Return `{ did, handle }`\n\n### `index.ts` — PDS startup\n1. Import and configure `@atproto/pds`\n2. Create the PDS instance with environment-based config\n3. Mount the metadata override middleware BEFORE PDS middleware\n4. Mount the magic-callback endpoint\n5. Start the server\n\n**Environment variables needed:**\n- `PDS_HOSTNAME` — e.g., `pds.certs.network`\n- `PDS_DATA_DIRECTORY` — path to PDS data\n- `PDS_BLOBSTORE_DISK_LOCATION` — blob storage path\n- `PDS_DID_PLC_URL` — PLC directory URL\n- `PDS_ADMIN_PASSWORD` — PDS admin password\n- `AUTH_SERVICE_URL` — sidecar URL (e.g., `https://auth.pds.certs.network`)\n- `CALLBACK_SECRET` — shared HMAC secret for signed callbacks\n\n## Don't\n- Don't fork or modify `@atproto/pds` source code — use it as a dependency\n- Don't implement the auth service routes (those are in the auth-service package)\n- Don't implement email sending (that's in the auth-service via shared mailer)\n- Don't disable stock login endpoints yet (that's a separate hardening task)\n- Don't implement consent screens","acceptance_criteria":"1. PDS starts and serves `/.well-known/oauth-authorization-server` with the sidecar's `authorization_endpoint`\n2. All other OAuth metadata fields (PAR, token, JWKS endpoints) still point to the PDS\n3. `GET /oauth/magic-callback` with valid HMAC signature issues an auth code and redirects to client\n4. `GET /oauth/magic-callback` with invalid signature returns 403\n5. `GET /oauth/magic-callback` with expired timestamp returns 403\n6. New account creation generates a random handle and stores email→DID mapping\n7. The stock PDS OAuth endpoints (PAR, token exchange) still work normally","status":"open","priority":1,"issue_type":"task","owner":"sharfy-test.climateai.org","estimated_minutes":60,"created_at":"2026-02-17T18:16:25.5113+08:00","created_by":"sharfy-test.climateai.org","updated_at":"2026-02-17T18:16:25.5113+08:00","labels":["scope:medium"],"dependencies":[{"issue_id":"hypercerts-qc3.7","depends_on_id":"hypercerts-qc3","type":"parent-child","created_at":"2026-02-17T18:16:25.512781+08:00","created_by":"sharfy-test.climateai.org"},{"issue_id":"hypercerts-qc3.7","depends_on_id":"hypercerts-qc3.4","type":"blocks","created_at":"2026-02-17T18:16:25.514074+08:00","created_by":"sharfy-test.climateai.org"}]}
{"id":"hypercerts-scaffold-0go","title":"Simplify JWK key generation with script","status":"in_progress","priority":2,"issue_type":"feature","owner":"adam@hypercerts.org","created_at":"2026-01-28T17:13:26.340137246+13:00","created_by":"Adam Spiers","updated_at":"2026-01-28T17:13:32.702507218+13:00"}
{"id":"hypercerts-scaffold-9rb","title":"Migrate OAuth scopes from transitional to granular permissions","description":"Code is using transitional OAuth scopes (transition:generic). Should migrate to granular permissions like repo:* or use ScopePresets.FULL_ACCESS from @hypercerts-org/sdk-core.","status":"open","priority":3,"issue_type":"task","owner":"adam@hypercerts.org","created_at":"2026-01-29T00:00:26.475561542+13:00","created_by":"Adam Spiers","updated_at":"2026-01-29T00:00:26.475561542+13:00"}
{"id":"hypercerts-scaffold-cw2","title":"Add lock mechanism for ATProto credentials","description":"ATProto SDK warning: No lock mechanism provided. Credentials might get revoked. Need to implement a lock mechanism to prevent credential revocation.","status":"open","priority":3,"issue_type":"task","owner":"adam@hypercerts.org","created_at":"2026-01-29T00:00:28.611778943+13:00","created_by":"Adam Spiers","updated_at":"2026-01-29T00:00:28.611778943+13:00"}
{"id":"hypercerts-scaffold-mk1","title":"Fix private JWK format - replace 'use' with 'key_ops'","description":"CRITICAL: Private JWK with 'use' property is causing authentication to fail completely. Error chain: ERR_CRYPTO_INVALID_JWK → ERR_JWK_INVALID → Unable to create JWT. Users cannot log in. Need to replace 'use' with valid 'key_ops' in the JWK configuration.","status":"closed","priority":0,"issue_type":"task","owner":"adam@hypercerts.org","created_at":"2026-01-29T00:00:27.640799834+13:00","created_by":"Adam Spiers","updated_at":"2026-01-29T00:05:01.57288757+13:00","closed_at":"2026-01-29T00:05:01.57288757+13:00","close_reason":"Fixed by regenerating JWK with npm run generate-jwk. The script already correctly sets key_ops and removes the deprecated use property."}
{"id":"hypercerts-scaffold-r25","title":"Configure allowedDevOrigins in next.config for ngrok","description":"Next.js detected cross-origin request from ngrok domain to /_next/* resources. Future versions will require explicit configuration of allowedDevOrigins. See: https://nextjs.org/docs/app/api-reference/config/next-config-js/allowedDevOrigins","status":"open","priority":2,"issue_type":"task","owner":"adam@hypercerts.org","created_at":"2026-01-29T00:00:24.942442259+13:00","created_by":"Adam Spiers","updated_at":"2026-01-29T00:00:24.942442259+13:00"}
