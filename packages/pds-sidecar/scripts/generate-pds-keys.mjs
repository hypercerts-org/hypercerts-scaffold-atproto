#!/usr/bin/env node
/**
 * generate-pds-keys.mjs
 *
 * Generates all required crypto keys for the PDS sidecar local dev setup.
 * Run this once and paste the output into .env.dev.
 *
 * Usage:
 *   node scripts/generate-pds-keys.mjs
 */

import { createRequire } from 'module';
import crypto from 'crypto';

// Generate PLC rotation key (secp256k1 private key, 32 bytes = 64 hex chars)
// The @atproto/pds expects the raw private key as a 64-char hex string.
function generatePlcRotationKey() {
  try {
    // Use Node.js built-in crypto to generate a secp256k1 key pair
    const { privateKey } = crypto.generateKeyPairSync('ec', {
      namedCurve: 'secp256k1',
    });
    // Export as DER and extract the raw 32-byte private key
    const der = privateKey.export({ type: 'pkcs8', format: 'der' });
    // In PKCS8 DER for secp256k1, the private key bytes are at a fixed offset.
    // The raw private key is the last 32 bytes of the DER structure (for secp256k1).
    // More reliably: use JWK export to get 'd' parameter.
    const jwk = privateKey.export({ format: 'jwk' });
    if (jwk.d) {
      // 'd' is base64url-encoded 32-byte private key
      const privKeyBytes = Buffer.from(jwk.d, 'base64url');
      return privKeyBytes.toString('hex').padStart(64, '0');
    }
    // Fallback: use random bytes (PDS will validate on startup)
    return crypto.randomBytes(32).toString('hex');
  } catch (err) {
    // Fallback if secp256k1 not supported
    return crypto.randomBytes(32).toString('hex');
  }
}

const plcRotationKey = generatePlcRotationKey();
const jwtSecret = crypto.randomBytes(32).toString('hex');
const sessionSecret = crypto.randomBytes(32).toString('hex');
const callbackSecret = crypto.randomBytes(32).toString('hex');
const adminPassword = crypto.randomBytes(16).toString('hex');

console.log('# Generated by scripts/generate-pds-keys.mjs');
console.log('# Paste these values into .env.dev');
console.log('');
console.log(`PDS_PLC_ROTATION_KEY_K256_PRIVATE_KEY_HEX=${plcRotationKey}`);
console.log(`PDS_JWT_SECRET=${jwtSecret}`);
console.log(`PDS_ADMIN_PASSWORD=${adminPassword}`);
console.log(`SESSION_SECRET=${sessionSecret}`);
console.log(`CALLBACK_SECRET=${callbackSecret}`);
